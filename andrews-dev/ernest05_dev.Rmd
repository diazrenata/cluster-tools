---
title: "Exploratory analyses using Ernest 2005 data"
output: html_notebook
---

```{r setup, get data}

library(neonbecs)
# replicatebecs::download_raw_paper_data()
# replicatebecs::process_raw_data()
communities <- replicatebecs::load_paper_data()
```

#### generate ISDs

```{r isd}
communities_energy <- lapply(communities, replicatebecs::add_energy_sizeclass)
isds <- lapply(communities_energy, make_isd)

isd_plot <- lapply(isds, plot_isd)

gridExtra::grid.arrange(grobs = isd_plot, nrow = 3)
```

#### fit gmms
```{r isd gmm}
gmms <- lapply(isds, fit_gmm)
```

#### integrate density and find peaks and pits

The output is obnoxious, sorry.

Green dots indicate local maxima; blue dots local minima. Red x's surrounding blue dots denote boundaries of "gaps", areas of the size spectrum where the density is <= 5% of the maximum density. No red x's means no gaps.

Communities have 2-4 modes. Most communities have at least one gap (but see the fourth one, sev-5pgrass.) 

The sixth one (sev-goatdraw) manages to have a mode that is at 5%? 

```{r integrated density, fig.width = 8, fig.height = 16, echo = F}

source(here::here("functions", "integrated_density.R"))

interval_size <- 0.001
min_size <- 0
max_size <- 8

integrated_densities <- lapply(gmms, get_integrated_density, 
                                             interval_size = interval_size,
                                             min_size = min_size,
                                             max_size = max_size) 
integrated_densities<- lapply(integrated_densities, add_all_pit_boundaries, threshold = .05)

integrated_density_plots<- lapply(integrated_densities, plot_integrated_density,
                                                      threshold_lines = FALSE,
                                                      pit_boundaries = TRUE)
gridExtra::grid.arrange(grobs = integrated_density_plots, nrow = 5)


```
#### How many modes and troughs do communities have?

Points on the line will have the maximum number of troughs they could have given the number of modes. Most (6/9) communities fall below the line. 

```{r plot modes and troughs}

community_stats <- data.frame(
  community_name= names(communities),
  nmodes = NA,
  ntroughs = NA
)


for(i in 1:nrow(community_stats)) {
  community_stats$nmodes[i] <- sum(integrated_densities[[i]]$start_is_peak)
    community_stats$ntroughs[i] <- sum(integrated_densities[[i]]$start_is_trough_start)
}

modes_troughs_plot <- ggplot2::ggplot(data = community_stats, ggplot2::aes(x = nmodes, y = ntroughs)) +
  ggplot2::ylim(-0.2, 4) + 
  ggplot2::xlim(0, 5) +
  ggplot2::geom_jitter(inherit.aes = TRUE, width = .2, height = .1) + 
  ggplot2::geom_abline(slope = 1, intercept = -1) +
  ggplot2::theme_bw()

modes_troughs_plot
```



#### Do species have means or tails in troughs?

Plotting species mean probability density against their size. Error bars are 1 standard deviation. Line is 5%. 

If a species' *mean* is below 5%, it is kind of a "gap specialist". If only the tail of its standard deviation is below 5%, the individuals in the gap are unusually-improbably-sized for their species (juveniles, pregnant, maybe?).  

```{r species breakdown, fig.width = 8, fig.height = 24, echo = F}
dat_p_args_list <- list()
for(i in 1:9) {
  dat_p_args_list[[i]] <- list(integrated_density = integrated_densities[[i]],
                               isd = isds[[i]])
}

dat_ps <- lapply(dat_p_args_list, get_dat_p)

species_summaries <- lapply(dat_ps, get_species_summaries)

p_plots <- lapply(species_summaries, plot_species_p, threshold = 0.05)

gridExtra::grid.arrange(grobs = p_plots, nrow = 5)


```

<!-- #### Mode structure -->
<!-- ```{r mode structure, include = F, fig.width = 8, fig.height = 24, echo = F} -->

<!-- mode_thresholdeds <- get_mode_dom_community(dat_ps[[1]], integrated_densities[[1]]) -->

<!-- mode_plot <- plot_mode_dom(mode_thresholdeds) -->

<!-- gridExtra::grid.arrange(grobs = mode_plots, nrow = 5) -->

<!-- ``` -->

#### BSDs (for reference)

```{r plot bsds}

bsds <-lapply(communities, replicatebecs::make_bsd)
bsd_plots <- lapply(bsds, replicatebecs::plot_bsd)
gridExtra::grid.arrange(grobs = bsd_plots, nrow = 3)

```