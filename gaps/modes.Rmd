---
title: "Exploring methods for analyzing the structure of modes"
output: html_notebook
---

### Setup

Get data, fit GMM

```{r setup}
library(neonbecs)
library(ggplot2)
dat <- get_toy_portal_data() %>%
  replicatebecs::add_energy_sizeclass() %>%
  make_isd()

dat_gmm <- fit_gmm(dat)
gmm_pdf <- get_pdf(dat_gmm)

print(plot_isd(dat))
print(plot_gmm_pdf(gmm_pdf))
```

### 1

Evaluate density at regular, small, intervals; divide by total. 

```{r integrate gmm} 

source(here::here("functions", "integrated_density.R"))

interval_size <- 0.001
min_size <- 0
max_size <- 8

integrated_density <- get_integrated_density(dat_gmm = dat_gmm, 
                                             interval_size = interval_size,
                                             min_size = min_size,
                                             max_size = max_size)

integrated_density_plot <- plot_integrated_density(integrated_density = integrated_density,
                                                   pit_boundaries = F)
print(integrated_density_plot)

```



Look for intervals with low P. Depending on the threshold for P, these could be regions of no or few individuals or just the least heavily represented.

```{r thresholded density estimates} 

integrated_density <- add_all_pit_boundaries(integrated_density = integrated_density,
                                             threshold = .08) # if lower will not find any pits

integrated_density_plot_wb <- plot_integrated_density(integrated_density = integrated_density,
                                                      threshold_lines = FALSE,
                                                      pit_boundaries = TRUE)

print(integrated_density_plot_wb)


trough_sizes <- integrated_density %>%
  dplyr::filter(is_in_trough) %>%
  dplyr::select(start) %>%
  dplyr::mutate(ln_size = signif(start, digits = 4)) %>%
  dplyr::select(ln_size) %>%
  dplyr::distinct()

rous <- dat %>%
  dplyr::mutate(ln_size = signif(ln_size, digits = 4)) %>%
  dplyr::filter(ln_size %in% trough_sizes$ln_size)

print(nrow(rous))

```


Per-species probabilities (using Portal data)

```{r per species probs}

intd_tojoin <- integrated_density %>%
  dplyr::rename(ln_size2 = start) %>%
  dplyr::mutate(ln_size2 = as.character(ln_size2))

dat_p <- dat %>%
  dplyr::mutate(ln_size2 = as.character(signif(ln_size, digits = 4))) %>%
  dplyr::left_join(intd_tojoin, by = "ln_size2") %>%
  dplyr::select(-ln_size2)

species_summaries <- dat_p %>%
  dplyr::group_by(individual_species_ids) %>%
  dplyr::summarise(mean_size = mean(ln_size),
                   mean_p = mean(by_max),
                   sd_p = sd(by_max),
                   prop_in_trough = mean(is_in_trough)) %>%
  dplyr::ungroup()
species_summaries <- species_summaries %>%
  dplyr::mutate(sd_p = tidyr::replace_na(data = species_summaries$sd_p, replace = 0))

species_summary_plot <- ggplot2::ggplot(data = species_summaries, aes(x =mean_size, y = mean_p)) +
  ggplot2::ylim(0, 1) +
  ggplot2::geom_point(data = species_summaries, inherit.aes = TRUE, size = 2) +
  ggplot2::geom_point(data = species_summaries, aes(x = mean_size, y = mean_p - sd_p), size = .5) + 
  ggplot2::geom_point(data = species_summaries, aes(x = mean_size, y = mean_p + sd_p), size = .5) +
  ggplot2::geom_hline(yintercept = 0.08, color = "blue") +
  ggplot2::theme_bw() +
  ggplot2::geom_segment(x = min(integrated_density[which(integrated_density$start_is_peak), "start"]), y = 0,
                        xend = min(integrated_density[which(integrated_density$start_is_peak), "start"]), yend = 0.08, color = "blue") +
  ggplot2::geom_segment(x = max(integrated_density[which(integrated_density$start_is_peak), "start"]), y = 0,
                        xend = max(integrated_density[which(integrated_density$start_is_peak), "start"]), yend = 0.08, color = "blue") +
  ggplot2::geom_point(aes(x = mean_size, y = prop_in_trough), color = "purple")

species_summary_plot 

individuals_plot <- ggplot2::ggplot(data = dat_p, aes(x = ln_size, y = by_max, color = individual_species_ids)) + 
  ggplot2::geom_jitter(size = .5) +
  ggplot2::geom_point(data = species_summaries, aes(x = mean_size, y = mean_p, color = individual_species_ids), size = 3) +
  ggplot2::geom_hline(yintercept = 0.08) +
  
  ggplot2::theme_bw()

individuals_plot

```

- No species seem to live in the troughs between the modes. The individuals in the troughs are outliers from otherwise modal species. 
- There *are* species that are entirely below the threshold (0.8 for this, because anything lower would not put any individuals in the troughs - this is for development, not real analysis), but they are below/above the peaks. So trailing edges on clumps, not weirdos between clumps. 

What happens if I run a GMM on the BSD?

```{r gmm on bsd}

dat_bsd <- replicatebecs::make_bsd(dat) %>%
  dplyr::rename(ln_size = ln_mass)

bsd_gmm <- neonbecs::fit_gmm(dat_bsd)

bsd_gmm_pdf <- get_pdf(bsd_gmm)

bsd_gmm_plot <- plot_gmm_pdf(bsd_gmm_pdf)
bsd_gmm_plot2 <- bsd_gmm_plot +
  ggplot2::ylim(0, .75) +
  ggplot2::geom_point(data = dat_bsd, aes(x = ln_size, y = 0.6), color = "green")
bsd_gmm_plot2



```



Look at relationship between P and (cumulative?) species richness/nb_ind?

```{r cumulative richness}

richness <- data.frame(start = seq(1, 0, by = -.5),
                       n_ind = NA,
                       n_spp = NA,
                       prop_ind = NA,
                       prop_spp = NA,
                       prop_richness = NA)

N <- as.numeric(nrow(dat_p))
S <- as.numeric(length(unique(dat_p$individual_species_ids)))

for (i in 2:(nrow(richness))){
  
  this_density <- dat_p %>%
    dplyr::filter(dplyr::between(by_max, richness$start[i], richness$start[i-1]))
  
  richness$n_ind[i] <- nrow(this_density)
  richness$n_spp[i] <- length(unique(this_density$individual_species_ids))
  richness$prop_ind[i] <- nrow(this_density) / N
  richness$prop_spp[i] <- length(unique(this_density$individual_species_ids)) / S
  richness$prop_richness[i] <- (nrow(this_density) / N) / (length(unique(this_density$individual_species_ids)) / S)
  
}

richness_prop_plot <- ggplot2::ggplot(data = richness, ggplot2::aes(x = start, y = prop_richness)) + 
  ggplot2::ylim(0, (.1 + max(richness$prop_richness))) + 
  ggplot2::geom_point() + 
  ggplot2::theme_bw()

richness_prop_plot


richness_both_plot <- ggplot2::ggplot(data = richness, ggplot2::aes(x = start, y = prop_spp)) +
  ggplot2::ylim(0, 1) +
  ggplot2::geom_point(ggplot2::aes(x = start, y = prop_spp), color = "green") +
  ggplot2::geom_point(ggplot2::aes(x = start, y = prop_ind), color = "blue") +
  ggplot2::theme_bw()
richness_both_plot
```


```{r mode structure} 

mode_threshold = .08

get_mode_dom <- function(threshold, dat_p) {
  modes <- dat_p %>%
    dplyr::filter(by_max > threshold)
  
  mode_richness <- as.numeric(length(unique(modes$individual_species_ids)))
  mode_abund <- as.numeric(nrow(modes))
  
  mode_dom <- (mode_richness / S) / (mode_abund / N)
  
  return(mode_dom)
}
mode_thresholds <- data.frame(
  threshold = seq(.01, 1, by = 0.01),
  mode_dom = vapply(seq(0.01, 1, by = 0.01), FUN = get_mode_dom, 
                    dat_p = dat_p, FUN.VALUE = .75)
)

thresh_plot <- ggplot2::ggplot(data = mode_thresholds, 
                               ggplot2::aes(x = threshold, y = mode_dom)) +
  ggplot2::geom_point() + 
  ggplot2::geom_hline(yintercept = 1) +
  ggplot2::theme_light()

thresh_plot

```